<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Twitch Chat</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.11.8/semantic.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.11.8/semantic.min.js"></script>
    <script>
        console.log("Started client");
        var irc = require("irc"),
                fs = require("fs"),
                request = require("request");
        var config = JSON.parse(fs.readFileSync("config.json"));
        var username = config["irc"]["nick"],
                token = config["irc"]["token"];
        var mods = [],
                users = [];

        var channelhtmls = [],
                userlisthtml = [];
        var activechannel = "";
        function pad(num, size) {
            var s = num+"";
            while (s.length < size) s = "0" + s;
            return s;
        }
        var client = new irc.Client('irc.twitch.tv', username,
                {
                    userName: username, // IRC Name
                    realName: username, // Wird nicht wirklich gebraucht
                    port: 6667,
                    localAddress: null,
                    debug: false, // Nur für Testinstanz an, genz nützlich um Pings, gesendete Nachrichten etc. zu sehen
                    showErrors: true,
                    autoRejoin: true,
                    autoConnect: true,
                    channels: [],
                    secure: false,
                    selfSigned: false,
                    certExpired: false,
                    floodProtection: false,
                    floodProtectionDelay: 1000,
                    sasl: false,
                    stripColors: false,
                    channelPrefixes: "&#",
                    messageSplit: 999, // 999 ist maximale Twitch Nachrichtenlänge
                    encoding: '',
                    password: token // Wirde zuvor festgelegt aus A) Stdin B) Config File
                }
        );
        var groupchatclient = new irc.Client('199.9.253.119', username,
                {
                    userName: username, // IRC Name
                    realName: username, // Wird nicht wirklich gebraucht
                    port: 6667,
                    localAddress: null,
                    debug: true, // Nur für Testinstanz an, genz nützlich um Pings, gesendete Nachrichten etc. zu sehen
                    showErrors: true,
                    autoRejoin: true,
                    autoConnect: true,
                    channels: [],
                    secure: false,
                    selfSigned: false,
                    certExpired: false,
                    floodProtection: false,
                    floodProtectionDelay: 1000,
                    sasl: false,
                    stripColors: false,
                    channelPrefixes: "&#",
                    messageSplit: 999, // 999 ist maximale Twitch Nachrichtenlänge
                    encoding: '',
                    password: token // Wirde zuvor festgelegt aus A) Stdin B) Config File
                }
        );


        var clientaws = new irc.Client('irc.chat.twitch.tv', username,
                {
                    userName: username, // IRC Name
                    realName: username, // Wird nicht wirklich gebraucht
                    port: 80,
                    localAddress: null,
                    debug: true, // Nur für Testinstanz an, genz nützlich um Pings, gesendete Nachrichten etc. zu sehen
                    showErrors: true,
                    autoRejoin: true,
                    autoConnect: true,
                    channels: [],
                    secure: false,
                    selfSigned: false,
                    certExpired: false,
                    floodProtection: false,
                    floodProtectionDelay: 1000,
                    sasl: false,
                    stripColors: false,
                    channelPrefixes: "&#",
                    messageSplit: 999, // 999 ist maximale Twitch Nachrichtenlänge
                    encoding: '',
                    password: token // Wirde zuvor festgelegt aus A) Stdin B) Config File
                }
        );
        client.send('CAP', 'REQ', 'twitch.tv/commands');
        client.send('CAP', 'REQ', 'twitch.tv/membership');
        client.send('CAP', 'REQ', 'twitch.tv/tags');
        clientaws.send('CAP', 'REQ', 'twitch.tv/commands');
        function whisper(username, message) {
            groupchatclient.send("PRIVMSG", "#jtv", "/w " + username + " " + message);
        }
        function join(channel) {
            client.join(channel);
            mods[channel] = [];
            users[channel] = [];
            userlisthtml[channel] = [];
            channelhtmls = [];
            switchchannel(channel);
            $("#channels").append("<div id='channel' onclick='switchchannel(\"" + channel +  "\")'>" + channel + "</div>")

        }
        function log(line, channel, premsg, aftermsg) {
            console.log(line);
            if (premsg == undefined) {
                premsg = "";
            }
            if (aftermsg == undefined) {
                aftermsg = "";
            }
            if (config.timestamps) {
                var date = new Date();
                if (channel == activechannel) {
                    $("#messages").append("[" + pad(date.getHours(), 2) + ":" +pad(date.getMinutes(), 2)+":"+pad(date.getSeconds(), 2)+"] " + premsg + " " + line + aftermsg + "<br>");
                }
                channelhtmls[channel] = channelhtmls[channel] + "[" + pad(date.getHours(), 2) + ":" +pad(date.getMinutes(), 2)+":"+pad(date.getSeconds(), 2)+"] " + premsg + " " + line + aftermsg + "<br>";
            }else {
                if (channel == activechannel) {
                    $("#messages").append( premsg + " " + line + aftermsg + "<br>");
                }
                channelhtmls[channel] = channelhtmls[channel] +   premsg + " " + line + aftermsg + "<br>";
            }
        }
        function switchchannel(channel) {
            console.log("Switching active Channel to " + channel);
            if (channel !== activechannel) {
                activechannel = channel;
                if (channelhtmls[channel] == undefined) {
                    channelhtmls[channel] = "";
                } else {
                    $("#messages").html(channelhtmls[channel]);
                }

                $("#chatters").html(userlisthtml[channel]);
            }
        }
        function handlemessage(message, channel, username) {
            var premsg ='';
            if (mods[channel].indexOf(username) !== -1) {
                premsg = "<img class='modicon' src='mod.png' height='14px'>";
            }
            log(username + ": " + message, channel, premsg)
        }
        client.on('raw', function (message) {
            console.log(message);
            if (message.args[1] == "Error logging in" && message.command == "NOTICE") {
                alert("Login error");
            } else if ((message.args[1] !== undefined) && message.command == "NOTICE") {
            }
            if (message.args[1] !== undefined) {
                if (message.args[1].split(" ")[0] == "ACTION") {
                    console.log("omg its a /me");
                    log(message.nick + " " + message.args[1].substr(7, message.args[1].length), message.args[0]);
                }
            }
            if (message.args[1] !== undefined && message.args[2] !== undefined && message.command == "MODE") {
                console.log("Mode!");
                // Mode gefunden!
                if (message.args[1] == "+o") {
                    // Mod hinzufügen
                    mods[message.args[0]].push(message.args[2]);
                } else {
                    // Mod entfernen
                    var modindex = mods[message.args[0]].indexOf(message.args[2]);
                    if (modindex > -1) {
                        mods[message.args[0]].splice(modindex, 1)
                    }
                }
                builduserlist(message.args[0]);
            }
            if (message.args[0] !== undefined && message.command == "JOIN") {
                console.log("Join!");
                // Join!
                if (users[message.args[0]].indexOf(message.nick) == -1) {
                    users[message.args[0]].push(message.nick);
                }
                builduserlist(message.args[0]);
                console.log("JOIN " + message.nick + " " + message.args[0]);
            }
            if (message.commandType == "normal" && message.args[0] !== undefined) {
                console.log("Got message");
                var splitmessage = message.args[0].split(" ");
                console.log("Splitted Message");
                if (splitmessage[1] == "PRIVMSG") {
                    console.log("Is PRIVMSG");
                    var splitinfo = message.command.split(";");
                    console.log("Info splitted");
                    var username = splitinfo[1].substr(13, splitinfo[1].length);
                    console.log("Username splitted");
                    var channel = splitmessage[2].substr(1, splitmessage[2].length);
                    channel = "#" + channel;
                    console.log("Channel splitted");
                    var color = splitinfo[0].substr(7);
                    console.log("Color splitted");
                    var message = message.args[0].replace(splitmessage[0] + " " + splitmessage[1] + " " + splitmessage[2] + " :", "");
                    console.log("Message parsed");
                    var emotes = splitinfo[2].substr(7).split("/");
                    console.log("Emote list splitted");
                    var isturbo = false;
                    if (color=="") {
                        color="#FFFFF";
                    }
                    if (splitinfo.indexOf("turbo=1") > -1) {
                        isturbo = true;
                    }
                    console.log("Turbo checked");
                    message = message.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    console.log("Message escaped");
                    if (emotes[0] !== undefined && emotes[0] !== ""){
                        emotes.forEach(function(currentemote) {
                            var idsplit = currentemote.split(":");
                            var startstop = idsplit[1].split("-");
                            message = message.replace(message.substr(startstop[0], startstop[1]+1), "<img src='https://static-cdn.jtvnw.net/emoticons/v1/" + idsplit[0] + "/1.0' class='modicon'>");
                        })

                    }
                    console.log("Emotes parsed");
                    var premsg = '';
                    console.log("Channel: "+ channel);
                    if (username.toLowerCase() == channel.substr(1)) {
                        premsg += "<img class='modicon' src='broadcaster.png' height='14px'>";
                    } else if (splitinfo.indexOf("mod=1") > -1) {
                        premsg += "<img class='modicon' src='mod.png' height='14px'>";
                    }
                    console.log("Modicon added");
                    if (isturbo) {
                        premsg += "<img class='modicon' src='turbo.png' height='14px'>";
                    }
                    console.log("Turbo Icon added");
                    premsg += "<span style='color: " + color + ";'>" + username + "</span>: ";
                    console.log("Username added");
                    log(premsg + message, channel);
                    if (users[channel].indexOf(username.toLowerCase()) == -1) {
                        users[channel].push(username.toLowerCase())
                    }

                }

            }
        });
        clientaws.on('raw', function (message) {
            console.log(message);
            if (message.args[1] == "Error logging in" && message.command == "NOTICE") {
                alert("Login error");
            } else if ((message.args[1] !== undefined) && message.command == "NOTICE") {
                if (message.args[1].replace("The moderators of this room are: ", "") !== message.args[1]) {
                    log(message.args[1], message.args[0], "<i>")
                }


            }
            console.log(message.args[1] + message.args[2] + message.command);
            if (message.args[1] !== undefined && message.args[2] !== undefined && message.command == "MODE") {
                console.log("Mode!");
                // Mode gefunden!
                if (message.args[1] == "+o") {
                    // Mod hinzufügen
                    mods[message.args[0]].push(message.args[2]);
                } else {
                    // Mod entfernen
                    var modindex = mods[message.args[0]].indexOf(message.args[2]);
                    if (modindex > -1) {
                        mods[message.args[0]].splice(modindex, 1)
                    }
                }
                builduserlist(message.args[0]);
            }
            if (message.args[0] !== undefined && message.command == "JOIN") {
                console.log("Join!");
                // Join!
                users[message.args[0]].push(message.nick);
                builduserlist(message.args[0]);
                console.log("JOIN " + message.nick + " " + message.args[0]);
            }
        });
        function builduserlist(channel) {
                    var stringbuild = "<ul class='userlist'>";
                    if (mods[channel].indexOf(channel.substr(1)) !== -1) {
                        stringbuild += "<li><img class='modicon' src='broadcaster.png' height='14px'> " + channel.substr(1) + "</li>";
                    }
                    mods[channel].forEach(function(current) {
                        if (current !== channel.substr(1)) {
                            stringbuild += "<li><img class='modicon' src='mod.png' height='14px'> " + current + "</li>";
                        }
                    });
                    users[channel].forEach(function(current) {
                        if (mods[channel].indexOf(current) == -1) {
                            stringbuild += "<li>" + current + "</li>";
                        }
                    });
                    stringbuild+="<ul>";
                    userlisthtml[channel] = stringbuild;
                    if (activechannel == channel) {
                        $("#chatters").html(userlisthtml[channel]);
                    }
        }
        //client.on('message', function (username, channel, text, message) {
        //    handlemessage(text, channel, username);
         //   console.log(message)
        //});
        clientaws.on('message', function (username, channel, text) {
            handlemessage(text, channel, username);
        });
        var iteration = 2;
        config["channels"].forEach(function(current) {
            setTimeout(function() {
                join(current);
            }, iteration*1000);
            iteration++;
        })


    </script>
    <style>
        body {
            margin: 0;
            background: #222426;
            color: white;
        }
        #channels {
            height: 100%;
            width: 20%;
            position: absolute;
            overflow-y: scroll;
        }
        #chatters {
            width: 20%;
            height: 100%;
            left: 80%;
            top: 0;
            position: absolute;
            overflow-y: scroll;
        }
        #messages {
            width: 60%;
            height: 100%;
            position: absolute;
            left: 20%;
            overflow-y: scroll;

        }
        img.modicon {
            vertical-align: middle;
        }
        ul.userlist {
            list-style-type: none;
        }
        #channel {
            height: 5%;
            width: 100%;
            border-bottom: #4f4f4f;
            border-bottom-style: solid;
            text-align: center;
            vertical-align:middle;
        }
        #channel:hover {
            background: #100000;
        }

    </style>
</head>
<body>
    <div id="channels"></div>
    <div id="messages"></div>
    <div id="send"></div>
    <div id="chatters">

    </div>
</body>
</html>