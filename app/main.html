<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Twitch Chat</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.11.8/semantic.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.11.8/semantic.min.js"></script>
    <script>
        console.log("Started client");
        var irc = require("irc"),
                fs = require("fs");
        var username = "thekirschn",
                token = "";
        var mods = [];
        var config = JSON.parse(fs.readFileSync("config.json"));
        var channelhtmls = [];
        var activechannel = "";
        var client = new irc.Client('irc.twitch.tv', username,
                {
                    userName: username, // IRC Name
                    realName: username, // Wird nicht wirklich gebraucht
                    port: 6667,
                    localAddress: null,
                    debug: false, // Nur für Testinstanz an, genz nützlich um Pings, gesendete Nachrichten etc. zu sehen
                    showErrors: true,
                    autoRejoin: true,
                    autoConnect: true,
                    channels: [],
                    secure: false,
                    selfSigned: false,
                    certExpired: false,
                    floodProtection: false,
                    floodProtectionDelay: 1000,
                    sasl: false,
                    stripColors: false,
                    channelPrefixes: "&#",
                    messageSplit: 999, // 999 ist maximale Twitch Nachrichtenlänge
                    encoding: '',
                    password: token // Wirde zuvor festgelegt aus A) Stdin B) Config File
                }
        );
        var groupchatclient = new irc.Client('199.9.253.119', username,
                {
                    userName: username, // IRC Name
                    realName: username, // Wird nicht wirklich gebraucht
                    port: 6667,
                    localAddress: null,
                    debug: true, // Nur für Testinstanz an, genz nützlich um Pings, gesendete Nachrichten etc. zu sehen
                    showErrors: true,
                    autoRejoin: true,
                    autoConnect: true,
                    channels: [],
                    secure: false,
                    selfSigned: false,
                    certExpired: false,
                    floodProtection: false,
                    floodProtectionDelay: 1000,
                    sasl: false,
                    stripColors: false,
                    channelPrefixes: "&#",
                    messageSplit: 999, // 999 ist maximale Twitch Nachrichtenlänge
                    encoding: '',
                    password: token // Wirde zuvor festgelegt aus A) Stdin B) Config File
                }
        );


        var clientaws = new irc.Client('irc.chat.twitch.tv', username,
                {
                    userName: username, // IRC Name
                    realName: username, // Wird nicht wirklich gebraucht
                    port: 80,
                    localAddress: null,
                    debug: true, // Nur für Testinstanz an, genz nützlich um Pings, gesendete Nachrichten etc. zu sehen
                    showErrors: true,
                    autoRejoin: true,
                    autoConnect: true,
                    channels: [],
                    secure: false,
                    selfSigned: false,
                    certExpired: false,
                    floodProtection: false,
                    floodProtectionDelay: 1000,
                    sasl: false,
                    stripColors: false,
                    channelPrefixes: "&#",
                    messageSplit: 999, // 999 ist maximale Twitch Nachrichtenlänge
                    encoding: '',
                    password: token // Wirde zuvor festgelegt aus A) Stdin B) Config File
                }
        );
        client.send('CAP', 'REQ', 'twitch.tv/commands');
        client.send('CAP', 'REQ', 'twitch.tv/membership');
        clientaws.send('CAP', 'REQ', 'twitch.tv/commands');
        function whisper(username, message) {
            groupchatclient.send("PRIVMSG", "#jtv", "/w " + username + " " + message);
        }
        function join(channel) {
            client.join(channel);
            client.say(channel, "/mods");

        }
        function log(line, channel, premsg) {
            console.log(line);
            if (premsg == undefined) {
                premsg = "";
            }
            if (config.timestamps) {
                var date = new Date();
                if (channel == activechannel) {
                    $("#messages").append("[" + date.getHours() + ":" +date.getMinutes()+":"+date.getSeconds()+"] " + premsg + " " + line.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") + "<br>");
                }
                channelhtmls[channel] += "[" + date.getHours() + ":" +date.getMinutes()+":"+date.getSeconds()+"] " + premsg + " " + line.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") + "<br>";
            }else {
                if (channel == activechannel) {
                    $("#messages").append( premsg + " " + line.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") + "<br>");
                }
                channelhtmls[channel] +=  premsg + " " + line.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") + "<br>";
            }
        }
        function switchchannel(channel) {
            activechannel = channel;
            $("#messages").html(channelhtmls[channel]);
        }
        function handlemessage(message, channel, username) {
            var premsg ='';
            if (mods[channel].indexOf(username) !== -1) {
                premsg = "<img src='mod.png' height='14px'>";
            }
            log(username + ": " + message, channel, premsg)
        }
        client.on('raw', function (message) {
            console.log(message);
            if (message.args[1] == "Error logging in" && message.command == "NOTICE") {
                alert("Login error");
            } else if ((message.args[1] !== undefined) && message.command == "NOTICE") {
                console.log("GOT MODS!");
                if (message.args[1].replace("The moderators of this room are: ", "") !== message.args[1]) {
                    mods[message.args[0]] = message.args[1].replace("The moderators of this room are: ", "").split(", ");
                    var stringbuild = "<ul>";
                    mods[message.args[0]].forEach(function(current) {
                        stringbuild +="<li>"+current+"</li>";
                    });
                    stringbuild+="<ul>";
                    $("#moderators").append(stringbuild);
                }



            }
            if (message.args[1] !== undefined) {
                console.log("Arg1 not undefined");
                console.log(message.args[1]);
                console.log(message.args[1].split(" "));
                console.log(message.args[1].split(" ")[0]);
                if (message.args[1].split(" ")[0] == "ACTION") {
                    console.log("omg its a /me");
                    log(message.nick + " " + message.args[1].substr(7, message.args[1].length), message.args[0]);
                }
            }
        });
        clientaws.on('raw', function (message) {
            console.log(message);
            if (message.args[1] == "Error logging in" && message.command == "NOTICE") {
                alert("Login error");
            } else if ((message.args[1] !== undefined) && message.command == "NOTICE") {
                if (message.args[1].replace("The moderators of this room are: ", "") !== message.args[1]) {
                    mods[message.args[0]] = message.args[1].replace("The moderators of this room are: ", "").split(", ");
                    var stringbuild = "<ul>";
                    mods[message.args[0]].forEach(function(current) {
                        stringbuild +="<li>"+current+"</li>";
                    });
                    stringbuild+="<ul>";
                    $("#moderators").append(stringbuild);
                    console.log(stringbuild);
                }


            }
        });
        client.on('message', function (username, channel, text, message) {
            handlemessage(text, channel, username);
            console.log(message)
        });
        clientaws.on('message', function (username, channel, text) {
            handlemessage(text, channel, username);
        });


    </script>
    <style>
        body {
            margin: 0;
            background: #222426;
            color: white;
        }
        #channels {
            height: 100%;
            width: 20%;
            position: absolute;
        }
        #chatters {
            width: 20%;
            height: 100%;
            left: 80%;
            top: 0;
            position: absolute;
        }
        #messages {
            width: 60%;
            height: 100%;
            position: absolute;
            left: 20%;
            overflow: scroll;

        }

    </style>
</head>
<body>
    <div id="channels"></div>
    <div id="messages"></div>
    <div id="send"></div>
    <div id="chatters">
        <div id="moderators"></div>
        <div id="normalusers"></div>
    </div>
</body>
</html>